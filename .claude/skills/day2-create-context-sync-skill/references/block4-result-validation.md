# Block 4: 결과 검증 (Result Validation)

> **Phase A 시작 시 반드시 아래 형태로 출력한다:**
> ```
> 📖 공식 문서: https://docs.claude.com/en/docs/claude-code/sub-agents
> ```

## EXPLAIN

### Block 3에서 여기까지

Block 3에서 여러 소스를 병렬로 수집했습니다. 그런데 모든 소스가 항상 성공하지는 않습니다.
이번 블록에서는 두 가지를 합니다:

1. **실패한 소스 재시도** - 왜 실패했는지 파악하고 다시 시도
2. **데이터 품질 검증** - 성공한 소스의 데이터가 실제로 쓸만한지 확인

### 실패 원인 분류

수집이 실패하는 이유는 크게 4가지입니다:

| 원인 | 설명 | 해결 방법 |
|------|------|----------|
| **인증 문제** | API 키가 만료되었거나 잘못된 경우 | 키 재발급 또는 재입력 |
| **네트워크 문제** | 인터넷 연결 불안정, 서버 점검 중 | 잠시 후 재시도 |
| **권한 문제** | 해당 채널/폴더에 접근 권한이 없는 경우 | 권한 요청 또는 대상 변경 |
| **도구 설정 문제** | MCP 서버가 꺼져 있거나 설정이 잘못된 경우 | `/mcp` 명령으로 상태 확인 후 재설정 |

> 가장 흔한 원인은 **인증/API 키 문제**입니다. Block 2에서 설정한 키가 만료되었거나 오타가 있는 경우가 많습니다.

### "데이터 품질"이란?

수집에 성공했다고 끝이 아닙니다. 가져온 정보가 **실제로 유용한지** 확인해야 합니다.

비유하면, 마트에서 장을 봤는데:
- 봉투를 열어보니 **비어있다** → 빈 결과
- 유통기한이 **지난 식품**을 샀다 → 오래된 데이터
- 같은 물건을 **두 번** 샀다 → 중복 데이터
- 냉장고에 **넣을 수 없을 만큼** 많이 샀다 → 너무 많은 데이터

데이터 품질 체크리스트:

| 문제 | 증상 | 대응 |
|------|------|------|
| **빈 결과** | 수집은 성공했지만 데이터가 0건 | 수집 범위(날짜, 채널 등)를 넓히기 |
| **오래된 데이터** | 한 달 전 메시지가 포함됨 | 날짜 필터를 최근 7일로 조정 |
| **중복 데이터** | 같은 메시지가 여러 번 나옴 | 중복 제거 로직 추가 |
| **너무 많은 데이터** | 수백 개의 메시지가 한꺼번에 | 필터링 기준(키워드, 중요도) 추가 |

### 스킬의 "추출할 정보" 섹션 조정

Block 0에서 만든 스킬에는 각 소스별로 "추출할 정보"가 적혀 있습니다.
예를 들어 Slack의 경우:

```
추출할 정보:
- 중요 공지사항
- 의사결정 사항
- 나에게 멘션된 메시지
- 답장이 필요한 질문
```

실제 수집 결과를 보고 이 목록이 현실과 맞는지 확인합니다:
- "의사결정 사항"을 추출하라고 했는데, 실제 채널에는 그런 내용이 거의 없다면? → 항목 수정
- "답장이 필요한 질문"이 너무 많다면? → 필터 조건 추가 (예: 최근 3일 이내만)
- 예상 못한 중요 정보 유형이 있다면? → 항목 추가

## EXECUTE

### 1단계: 실패 소스 재시도

Claude에게 아래와 같이 요청합니다:

```
Block 3에서 실패한 소스를 다시 시도해줘
```

Claude가 하는 일:

1. Block 3의 수집 결과에서 실패한 소스를 확인합니다
2. 실패 원인을 분석합니다:
   - MCP 서버 상태 확인 (`/mcp` 명령)
   - API 키 유효성 확인
   - 접근 권한 확인
3. 원인에 맞는 조치 후 재시도합니다
4. 재시도 결과를 보여줍니다:
   ```
   재시도 결과:
     Calendar: 인증 토큰 갱신 후 재수집 → 8개 일정 (성공 ✅)

   최종 수집 현황: 4/4 소스 성공
   ```

> 모든 소스가 Block 3에서 성공했다면 이 단계는 건너뜁니다.

### 2단계: 데이터 품질 확인

Claude에게 수집된 데이터의 품질을 확인하도록 요청합니다:

```
수집된 데이터의 품질을 확인해줘
```

Claude가 하는 일:

1. 각 소스별 수집 결과를 점검합니다:
   - 빈 결과가 있는지 확인
   - 데이터 날짜 범위가 적절한지 확인
   - 중복 데이터가 있는지 확인
   - 데이터 양이 적절한지 확인

2. 품질 리포트를 보여줍니다:
   ```
   데이터 품질 리포트:
     Slack: ✅ 양호 (47개 메시지, 최근 7일)
     Gmail: ⚠️ 조정 필요 (312개 이메일 → 필터링 추가 권장)
     Calendar: ✅ 양호 (8개 일정, 향후 7일)
     Notion: ⚠️ 조정 필요 (빈 결과 → 수집 범위 확대 권장)
   ```

3. 조정이 필요한 소스에 대해 스킬 파일을 수정합니다:
   - Gmail: `limit=50` 추가 또는 "안 읽은 이메일만" 필터 추가
   - Notion: 데이터베이스 ID 확인 또는 수집 범위 변경

### 3단계: 스킬의 "추출할 정보" 업데이트

실제 데이터를 기반으로 스킬 파일의 "추출할 정보" 섹션을 현실에 맞게 조정합니다.

```
수집 결과를 보고 스킬의 "추출할 정보" 섹션을 실제 데이터에 맞게 수정해줘
```

수정 전후 예시:
```
[수정 전]
추출할 정보:
- 중요 공지사항
- 의사결정 사항

[수정 후]
추출할 정보:
- 중요 공지사항
- 의사결정 사항 ("확정", "결정" 키워드 포함)
- 링크가 포함된 공유 자료   ← 실제 데이터에서 발견한 패턴 추가
```

## QUIZ

```json
AskUserQuestion({
  "questions": [
    {
      "question": "수집이 실패하는 가장 흔한 원인은 무엇인가요?",
      "header": "Quiz 4-1",
      "options": [
        {"label": "인증/API 키 문제", "description": "키 만료, 오타, 권한 부족 등이 가장 흔함"},
        {"label": "인터넷 연결 문제", "description": "가끔 발생하지만 가장 흔하지는 않음"},
        {"label": "Claude의 버그", "description": "Claude 자체 문제보다는 외부 서비스 연결 문제가 대부분"}
      ],
      "multiSelect": false
    },
    {
      "question": "수집된 데이터가 너무 많을 때 어떻게 하나요?",
      "header": "Quiz 4-2",
      "options": [
        {"label": "필터링 기준을 추가한다", "description": "날짜 범위, 키워드, 중요도 등으로 걸러냄"},
        {"label": "전부 다 사용한다", "description": "너무 많은 데이터는 오히려 핵심을 놓치게 함"},
        {"label": "수집을 포기한다", "description": "포기가 아니라 조건을 조정하면 됨"}
      ],
      "multiSelect": false
    }
  ]
})
```

정답: 4-1은 1번, 4-2는 1번.
